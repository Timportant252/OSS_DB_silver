# バックアップとリストア
## バックアップとリストアの方法

PostgreSQLの稼働中にバックアップを行う方法にはpg_dumpコマンド、pg_dumpallコマンドがある。  
リストアの方法はバックアップ形式によってことなり、平文形式ではpsqlコマンド、平文形式以外ではpg_restoreコマンドを使用する。  

| バックアップ形式 | バックアップコマンド | リストアコマンド |
| ---- | ---- | ---- |
| 平文形式 | pg_dump pg_dumpall | psql |
| 平文形式以外 | pg_dump | pg_restore | 
* リストア ... バックアップしていたものの復元  

PostgreSQL稼働中にバックアップを取得するには、pg_dumpコマンドかpg_dumpallコマンドを使用する。  
DBを指定してバックアップする場合はpg_dumpコマンド  
全てのDB、DBクラスタをバックアップする場合はpg_dumpallコマンドを使用する。  
pg_dumpコマンドには-Fオプションをつけてバックアップの出力形式を指定できる。  
pg_dumpallコマンドは複数のDBへ接続を行うため、スーパーユーザで実行する。  

* pg_dump 接続オプション -Fp / -Fc/ -Ft -f ファイル名 DB名 
* pg_dump -Fp examdb -f examdb.dump 
* pg_dumpall 接続オプション -f ファイル名  
* pg_dumpall -f db.sql

pg_dump/ pg_dumpallコマンドの主なオプション

| オプション | 説明 | 
| ---- | ---- |
| -Fp | 出力形式として平文(Plain)を指定する。指定がない場合のデフォルト | 
| -Fc | 出力形式としてカスタム(Custom)形式を指定する。 | 
| -Ft | 出力形式としてtar形式を指定する。 | 
| -f | バックアップ先のファイル名を指定する。 未指定の場合は標準出力 |

平文の場合はSQLの羅列で出力されるため、psqlコマンドで読み込むことができる。  
主に、ことなるOS間でのデータ移行や、バージョン間でのデータ移行に利用される。  
pg_dumpコマンド、pg_dumpallコマンドはユーザがDBにアクセスしている場合でも、データの一貫性のあるバックアップを取得できる。  

## 平文形式のリストア

平文でバックアップされたファイルはpsqlコマンドの-fオプションを使ってリストアができる。  
* psql 接続オプション -f ファイル名
* psql -f db.sql

## 平文形式以外のリストア

カスタム形式やtar形式のように平文以外で取得したバックアップはpg_restoreコマンドを使用してリストアができる。  
* pg_restore 接続オプション オプション -d データベース名 ファイル名
* pg_restore -d examdb examdb.dump

主なオプション
| オプション | 説明 |
| ---- | ---- |
| -d | リストア先のDB名を指定する。 |

-d オプションでDB名を指定しない場合は、平文形式のSQLコマンドが標準出力される。  

## バックアップ&リストアの組み合わせ

**平文でのバックアップ&リストアの例**
```$ pg_dump -f examdb.sql```
```$ dropdb examdb```
```$ createdb examdb```
```$ psql -f examdb.sql examdb```

**カスタム形式でのバックアップ&リストアの例**  
```
$ pg_dump -Fc examdb.dump  
$ dropdb examdb  
$ createdb examdb 
$ pg_restore -d examdb examdb.dump
```  


# ディレクトリコピーによるバックアップ&リストア

サーバを停止した状態でDBクラスタをコピーすることで、バックアップする方法もある。  
DBクラスタのコピーによって取得したバックアップはサーバが動作していないことを確認した上でリストアする。  
**物理的なディレクトリ全体をコピーするバックアップ方法。**  




